name: 自动部署

# 触发条件：当推送到 main 分支时
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 直接进行 SSH 部署，跳过所有可能卡住的步骤
    - name: SSH 部署到服务器
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        timeout: 30s
        command_timeout: 5m
        script: |
          echo "🚀 开始部署..."
          
          # 删除旧版本
          echo "🗑️ 清理旧版本..."
          if [ -d "/www/wwwroot/ScriptAnalysisTool" ]; then
            echo "删除旧项目目录..."
            rm -rf /www/wwwroot/ScriptAnalysisTool
          fi
          
          # 创建项目目录
          echo "📁 创建项目目录..."
          mkdir -p /www/wwwroot
          
          # 克隆最新代码
          echo "📥 克隆最新代码..."
          cd /www/wwwroot
          git clone https://github.com/zhangguizhou2017/ScriptAnalysisTool.git ScriptAnalysisTool
          cd ScriptAnalysisTool
          
          # 创建环境配置文件
          echo "⚙️ 创建环境配置文件..."
          cat > .env << EOF
          NODE_ENV=production
          
          # 数据库配置
          DB_HOST=localhost
          DB_PORT=3306
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=scriptanalysisdb
          
          # API 密钥配置
          API_KEYS=${{ secrets.API_KEYS }}
          REQUIRE_AUTH=false
          
          # CORS 配置
          ALLOWED_ORIGINS=*
          EOF
          
          # 安装/更新依赖
          echo "📦 安装主应用依赖..."
          npm ci --production
          
          # 安装 MCP 服务器依赖
          echo "📦 安装 MCP 服务器依赖..."
          cd script-mcp-server
          npm ci --production
          cd ..
          
          # 重启 PM2 进程
          echo "🔄 重启应用..."
          PORT=3001 pm2 restart script-analysis-tool || PORT=3001 pm2 start server.js --name script-analysis-tool
          
          # 等待应用启动
          echo "⏳ 等待应用启动..."
          sleep 3
          
          # 显示最终状态
          echo "✅ 部署完成！"
          pm2 status
          
          # 显示最近日志（不持续监听）
          echo "📋 最近日志:"
          pm2 logs script-analysis-tool --lines 5 --nostream || true
          
          echo "🎉 部署成功完成！应用已启动并运行正常。"